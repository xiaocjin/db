管理
====

##持久化

  Redis 支持两种方式的持久化，一种是 RDB 方式，一种是 AOF 方式。可以单独使用其中一种或将二者结合使用。
  
###RDB方式

  RDB 方式的持久化是通过快照（ snapshotting） 完成的，当符合一定条件时 Redis 会自动将内存中的所有数据进行快照并存储在硬盘上。进行快照的条件可以由用户在配置文件中自定义，由两个参数构成：时间和改动的键的个数。当在指定的时间内被更改的键的个数大于指定的数值时就会进行快照。 RDB 是 Redis 默认采用的持久化方式，在配置文件中已经预置了 3 个条件：
  * save   900   1 （在 15 分钟（ 900 秒钟）内有至少一个键被更改则进行快照）
  * save   300   10 
  * save   60   10000

  Redis 默认会将快照文件存储在当前目录的 dump.rdb 文件中，可以通过配置 dir 和 dbfilename 两个参数分别指定快照文件的存储路径和文件名。
  通过 RDB 方式实现持久化，一旦 Redis 异常退出，就会丢失最后一次快照以后更改的所有数据。
  
###AOF方式
  
  默认情况下 Redis 没有开启 AOF（ append   only   file） 方式的持久化，可以通过 appendonly 参数开启：
    
    appendonly   yes
  
  开启 AOF 持久化后每执行一条会更改 Redis 中的数据的命令， Redis 就会将该命令写入硬盘中的 AOF 文件。 AOF 文件的保存位置和 RDB 文件的位置相同，都是通过 dir 参数设置的，默认的文件名是 appendonly.aof， 可以通过 appendfilename 参数修改：
    
    appendfilename   appendonly.aof
  
  随着执行的命令越来越多， AOF 文件的大小也会越来越大，即使内存中实际的数据可能并没有多少。当达到一定条件时 Redis 就会自动重写 AOF 文件，这个条件可以在配置文件中设置：
    
    auto-aof-rewrite-percentage   100 
    auto-aof-rewrite-min-size   64mb
  
  需要注意的是虽然每次执行更改数据库内容的操作时， AOF 都会将命令记录在 AOF 文件中，但是事实上，由于操作系统的缓存机制，数据并没有真正地写入硬盘，而是进入了系统的硬盘缓存。。在默认情况下系统每 30 秒会执行一次同步操作，以便将硬盘缓存中的内容真正地写入硬盘，在这 30 秒的过程中如果系统异常退出则会导致硬盘缓存中的数据丢失。在 Redis 中我们可以通过 appendfsync 参数设置同步的时机：
    
    #   appendfsync   always 
    appendfsync   everysec 
    #   appendfsync   no
    
  Redis 允许同时开启 AOF 和 RDB， 既保证了数据安全又使得进行备份等操作十分容易。此时重新启动 Redis 后 Redis 会使用 AOF 文件来恢复数据，因为 AOF 方式的持久化可能丢失的数据更少。
  
##复制
  
  当一台服务器上的数据库更新后，可以自动将更新的数据同步到其他服务器上， Redis 提供了复制（ replication） 功能可以自动实现同步的过程。
  
###配置

  同步后的数据库分为两类，一类是主数据库（ master）， 一类是从数据库（ slave）。 主数据库可以进行读写操作，当发生写操作时自动将数据同步给从数据库。而从数据库一般是只读的，并接受主数据库同步过来的数据。
  
  在 Redis 中使用复制功能非常容易，只需要在从数据库的配置文件中加入“ slaveof 主数据库 IP 主数据库端口”即可，主数据库无需进行任何配置。

###原理
  
  当一个从数据库启动后，会向主数据库发送 SYNC 命令，主数据库接收到 SYNC 命令后会开始在后台保存快照（即 RDB 持久化的过程），并将保存期间接收到的命令缓存起来。当快照完成后， Redis 会将快照文件和所有缓存的命令发送给从数据库。从数据库收到后，会载入快照文件并执行收到的缓存的命令。当主从数据库断开重连后会重新执行上述操作，不支持断点续传。

###图结构
  
  从数据库不仅可以接收主数据库的同步数据，自己也可以同时作为主数据库存在，形成类似图的结构。
  
###读写分离

  通过复制可以实现读写分离以提高服务器的负载能力。在常见的场景中，读的频率大于写，当单机的 Redis 无法应付大量的读请求时（尤其是较耗资源的请求，比如 SORT 命令等）可以通过复制功能建立多个从数据库，主数据库只进行写操作，而从数据库负责读操作。
  
###从数据库持久化

  为了提高性能，可以通过复制功能建立一个（或若干个）从数据库，并在从数据库中启用持久化，同时在主数据库禁用持久化。

##安全

###可信的环境
  
  Redis 的默认配置会接受来自任何地址发送来的请求，即在任何一个拥有公网 IP 的服务器上启动 Redis 服务器，都可以被外界直接访问到。要更改这一设置，在配置文件中修改 bind 参数，如只允许本机应用连接 Redis， 可以将 bind 参数改成：
    
    bind   127.0.0.1
  
###数据库密码
  
  可以通过配置文件中的 requirepass 参数为 Redis 设置一个密码。
  
  配置 Redis 复制的时候如果主数据库设置了密码，需要在从数据库的配置文件中通过 masterauth 参数设置主数据库的密码，以使从数据库连接主数据库时自动使用 AUTH 命令认证。
  
